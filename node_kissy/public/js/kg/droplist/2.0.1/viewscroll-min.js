/*!build time : 2014-09-26 4:21:54 PM*/
KISSY.add("kg/droplist/2.0.1/viewscroll",["dom","event","overlay","kg/lap/0.0.1/"],function(a,b,c,d){function e(){this._init.apply(this,arguments)}var f=b("dom"),g=b("event"),h=b("overlay"),i=b("kg/lap/0.0.1/"),j="",k={selectedCls:"selected",focusCls:"focus",prefixId:"dropmenu-",prefixCls:"dropmenu-",menuItem:'<li class="{prefixCls}item" id="{prefixId}item{__id}" data-id="{__id}">{text}</li>',empty:"\u641c\u7d22\u65e0\u7ed3\u679c"},l={format:function(a){return a}};a.augment(e,a.EventTarget,{_init:function(b,c){var d=this,e=a.merge(l,c),g=new h({prefixCls:k.prefixCls});d.layer=g,d.elList=f.create("<ul></ul>"),d.datalist=b,d.format=e.format,d.mulSelect=e.mulSelect,g.on("afterRenderUI",function(){d._UIRender()}),this.on("hide",function(){d.focused=void 0})},_UIRender:function(){var b=this,c=b.layer,d=b.elList,e=c.get("el"),f=c.get("contentEl");f.append(d),b._bindList(),b.elWrap=e,b.elWrap.attr("id",k.prefixId+"wrap"+a.guid()),b.fire("UIRender")},emptyRender:function(a){this._list=[],f.html(this.elList,a||k.empty)},render:function(b){var c=this,d=c.lap,e=document.createDocumentFragment();return d&&d.stop(),c.lap?(a.later(function(){c.render(b)},20),!0):(f.html(c.elList,j),d=c.lap=i(b,{duration:30}),c._list=b,d.handle(function(a){var b=c._itemRender(a);b&&e.appendChild(b)}),d.batch(function(){f.append(e,c.elList)}),d.then(function(){f.append(e,c.elList),c.lap=null}),void d.start())},_itemRender:function(b){if(!b)return null;var c=this.format(a.clone(b)),d=a.substitute(k.menuItem,a.merge({prefixId:k.prefixId,prefixCls:k.prefixCls},c)),e=f.create(d),g=this.datalist.getSelectedData();return this.mulSelect?g&&a.inArray(b,g)&&this._selectByElement(e,b):g&&g.value===b.value&&this._selectByElement(e,b),e},_bindList:function(){var a=this,b=a.elList;g.on(b,"click",function(b){var c=b.target,d=k.prefixCls+"item";if(f.hasClass(c,d)||(c=f.parent(c,d)),c){b.stopPropagation();var e=f.attr(c,"data-id");a.fire("itemSelect",{id:e})}})},select:function(a){var b=this.getElement(a);b||(b=a=void 0),this._selectByElement(b,a),this.fire("select",{data:a})},_focus:function(b){var c=this.getElement(b);c||(c=b=void 0),this._setElementClass(c,this.focused,k.focusCls,!0),this.focused=b,this.scrollIntoView(b),this.mulSelect&&this.datalist.selected&&b&&a.inArray(b,this.datalist.selected)||this.fire("focus",{data:b})},_selectByElement:function(a,b){this._setElementClass(a,this.datalist.selected,k.selectedCls),this.focused=b},_setElementClass:function(a,b,c,d){if(b&&!this.mulSelect||d){var e=this.getElement(b);e&&f.removeClass(e,c)}a&&f.addClass(a,c)},focusNext:function(){function b(b){for(var e=d._list.length-b+1;e--;)if(!d.datalist.selected||!a.inArray(d._list[d._list.length-e],d.datalist.selected)){c=d._list[d._list.length-e];break}}var c,d=this,e=this.focused;if(e){var f=0;a.each(this._list,function(a,b){return a.value==e.value?(f=b,!1):void 0}),this.mulSelect?b(f+1):c=this._list[f+1]}else b(0);this._focus(c)},focusPrevious:function(){function b(b){for(b++;b--;)if(!d.datalist.selected||!a.inArray(d._list[b],d.datalist.selected)){c=d._list[b];break}}var c,d=this,e=this.focused;if(e){var f=0;a.each(this._list,function(a,b){return a.value==e.value?(f=b,!1):void 0}),this.mulSelect?b(f-1):c=this._list[f-1]}else b(this._list.length-1);this._focus(c)},selectFocused:function(){this.focused&&this.fire("itemSelect",{id:this.datalist.getClientId(this.focused)})},visible:function(a){var b=this.getVisible(),c=void 0===a?!b:a;b!==c&&(c?(this.layer.show(),this.fire("show")):(this.layer.hide(),this.fire("hide")))},destroy:function(){this.layer.destroy()},getVisible:function(){return this.layer.get("visible")},align:function(a){this.layer.set("align",a)},getElement:function(a){var b=this.datalist.getClientId(a);return b?f.get("#"+k.prefixId+"item"+b,this.elList):void 0},scrollIntoView:function(a){var b=this.getElement(a);f.scrollIntoView(b,this.elWrap)}}),d.exports=e});